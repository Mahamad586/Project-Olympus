name: Olympus Engine v4.0 - "The Versatile"

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Run on a single target (optional)'
        required: false
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours

jobs:
  unleash_the_kraken:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # If a single target is provided, use it. Otherwise, use the full list.
        target: ${{ github.event.inputs.target && fromJson(format('["{0}"]', github.event.inputs.target)) || fromJson(needs.read_targets.outputs.targets_json) }}
    needs: read_targets
    steps:
      - name: Checkout Olympus Codebase
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: pip install requests

      - name: ðŸš€ [Module] Reconnaissance
        run: |
          chmod +x modules/recon/run.sh
          ./modules/recon/run.sh ${{ matrix.target }}

      - name: ðŸ‘ï¸ [Module] Vulnerability Scanning
        run: |
          chmod +x modules/vuln_scan/run.sh
          ./modules/vuln_scan/run.sh ${{ matrix.target }}
          
      - name: ðŸ“± [Module] Android App Analysis
        run: |
          chmod +x modules/android_scan/run.sh
          ./modules/android_scan/run.sh ${{ matrix.target }}

      - name: ðŸ—£ï¸ [Module] Analyze and Report to Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python reporter.py ${{ matrix.target }}

  read_targets:
    runs-on: ubuntu-latest
    outputs:
      targets_json: ${{ steps.read_targets_file.outputs.targets_json }}
    steps:
      - name: Checkout Olympus Codebase
        uses: actions/checkout@v4
      - id: read_targets_file
        name: Read targets.txt into a JSON array
        run: |
          targets_json=$(jq -R -s -c 'split("\n") | map(select(length > 0))' targets.txt)
          echo "targets_json=$targets_json" >> $GITHUB_OUTPUT
